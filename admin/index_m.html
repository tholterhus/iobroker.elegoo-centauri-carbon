<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elegoo Centauri Carbon Adapter Settings</title>

```
<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../../lib/js/materialize.js"></script>

<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../lib/js/ace/ace.js"></script>
<script type="text/javascript" src="../../lib/js/ace/ext-language_tools.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>

<style>
    .adapter-container {
        padding: 20px;
        max-width: 1200px;
    }
    
    .logo {
        width: 64px;
        height: 64px;
    }
    
    /* Fix input field visibility */
    .input-field input[type=text], 
    .input-field input[type=number], 
    .input-field input[type=email], 
    .input-field input[type=url], 
    .input-field input[type=time], 
    .input-field input[type=date], 
    .input-field input[type=datetime], 
    .input-field input[type=datetime-local], 
    .input-field input[type=tel], 
    .input-field input[type=search], 
    .input-field textarea.materialize-textarea {
        color: #000 !important;
        background-color: #fff !important;
        border-bottom: 1px solid #9e9e9e !important;
    }
    
    .input-field input[type=text]:focus, 
    .input-field input[type=number]:focus {
        border-bottom: 1px solid #26a69a !important;
        box-shadow: 0 1px 0 0 #26a69a !important;
        color: #000 !important;
    }
    
    .input-field label {
        color: #9e9e9e !important;
    }
    
    .input-field label.active {
        color: #26a69a !important;
    }
    
    /* Fix helper text and description visibility */
    .helper-text {
        color: #666 !important;
        font-size: 12px !important;
        font-weight: normal !important;
    }
    
    /* Fix paragraph text visibility */
    .collapsible-body p {
        color: #424242 !important;
        line-height: 1.5;
    }
    
    /* Fix description text in cards */
    .card-panel p,
    .collection-item p {
        color: #424242 !important;
    }
    
    /* Fix checkbox visibility */
    [type="checkbox"]:checked + span:not(.lever):before {
        border-right: 2px solid #26a69a;
        border-bottom: 2px solid #26a69a;
    }
    
    /* Table styling */
    table.striped > tbody > tr:nth-child(odd) {
        background-color: rgba(242, 242, 242, 0.5);
    }
    
    .collection .collection-item {
        background-color: #fff;
        line-height: 1.5rem;
        padding: 10px 20px;
        margin: 0;
        border-bottom: 1px solid #e0e0e0;
    }
    
    /* Button styling */
    .btn {
        background-color: #26a69a;
    }
    
    .btn:hover, .btn-large:hover {
        background-color: #2bbbad;
    }
    
    /* Card panel styling */
    .card-panel {
        background-color: #fff;
        padding: 24px;
        margin: 0.5rem 0 1rem 0;
        border-radius: 2px;
        box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 1px 5px 0 rgba(0,0,0,0.12), 0 3px 1px -2px rgba(0,0,0,0.2);
    }
</style>
```

</head>

<body>

<div class="m adapter-container">

```
<div class="row">
    <div class="col s12 m4 l2">
        <img src="elegoo-centauri-carbon.png" class="logo" alt="Elegoo Centauri Carbon">
    </div>
</div>

<!-- Connection Settings -->
<div class="row">
    <div class="col s12">
        <ul class="collapsible">
            <li class="active">
                <div class="collapsible-header">
                    <i class="material-icons">wifi</i>
                    <span class="translate">Connection Settings</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <input class="value" id="host" type="text" data-default="192.168.178.34"/>
                            <label for="host" class="translate">Printer IP Address</label>
                            <span class="helper-text translate">IP address of your Elegoo Centauri Carbon printer</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <input class="value" id="port" type="number" min="1" max="65535" data-default="3030"/>
                            <label for="port" class="translate">WebSocket Port</label>
                            <span class="helper-text translate">WebSocket port (default: 3030)</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <input class="value" id="pollInterval" type="number" min="1000" max="300000" data-default="10000"/>
                            <label for="pollInterval" class="translate">Poll Interval (seconds)</label>
                            <span class="helper-text translate">How often to request status updates (10-300 seconds)</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <input class="value" id="reconnectInterval" type="number" min="5000" max="300000" data-default="30000"/>
                            <label for="reconnectInterval" class="translate">Reconnect Interval (seconds)</label>
                            <span class="helper-text translate">Wait time before reconnection attempts (5-300 seconds)</span>
                        </div>
                    </div>
                </div>
            </li>

            <!-- Camera Settings -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">videocam</i>
                    <span class="translate">Camera Settings</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col s12 m6">
                            <p>
                                <label>
                                    <input type="checkbox" class="value" id="enableCamera" data-default="true"/>
                                    <span class="translate">Enable Camera Integration</span>
                                </label>
                            </p>
                            <span class="helper-text translate">Enable camera stream monitoring and controls</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <input class="value" id="cameraPort" type="number" min="1" max="65535" data-default="8080"/>
                            <label for="cameraPort" class="translate">Camera Port</label>
                            <span class="helper-text translate">MJPEG camera stream port</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            <h6 class="translate">Camera Stream Information</h6>
                            <p class="translate">Common MJPEG stream URLs:</p>
                            <div class="collection">
                                <div class="collection-item">http://[PRINTER_IP]:8080/video_feed</div>
                                <div class="collection-item">http://[PRINTER_IP]:8080/stream.mjpg</div>
                                <div class="collection-item">http://[PRINTER_IP]/video_feed</div>
                            </div>
                        </div>
                    </div>
                </div>
            </li>

            <!-- Network Discovery -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">search</i>
                    <span class="translate">Connection Test</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col s12">
                            <p class="translate">Test the connection to verify your printer settings.</p>
                            <button id="test-connection" class="btn waves-effect waves-light" type="button">
                                <i class="material-icons left">play_arrow</i>
                                <span class="translate">Test Connection</span>
                            </button>
                            <div id="test-result" class="card-panel" style="display: none; margin-top: 10px;">
                                <span id="test-message"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </li>

            <!-- Alert Settings -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">notifications</i>
                    <span class="translate">Alert Settings</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col s12 m6">
                            <p>
                                <label>
                                    <input type="checkbox" class="value" id="enableAlerts" data-default="true"/>
                                    <span class="translate">Enable Alerts</span>
                                </label>
                            </p>
                            <span class="helper-text translate">Enable automatic alert generation</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <input class="value" id="alertClearTimeout" type="number" min="60" max="3600" data-default="300"/>
                            <label for="alertClearTimeout" class="translate">Alert Auto-Clear (seconds)</label>
                            <span class="helper-text translate">Time before alerts automatically clear (60-3600 seconds)</span>
                        </div>
                    </div>
                </div>
            </li>

            <!-- Test Connection -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">settings_ethernet</i>
                    <span class="translate">Advanced Settings</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col s12 m6">
                            <p>
                                <label>
                                    <input type="checkbox" class="value" id="enableAutoDiscovery" data-default="true"/>
                                    <span class="translate">Enable Auto-Discovery</span>
                                </label>
                            </p>
                            <span class="helper-text translate">Test printer connection on startup</span>
                        </div>
                        <div class="col s12 m6">
                            <p>
                                <label>
                                    <input type="checkbox" class="value" id="enableDebugLogging" data-default="false"/>
                                    <span class="translate">Enable Debug Logging</span>
                                </label>
                            </p>
                            <span class="helper-text translate">Enable detailed logging for troubleshooting</span>
                        </div>
                    </div>
                </div>
            </li>" type="button">
                                <i class="material-icons left">play_arrow</i>
                                <span class="translate">Test Connection</span>
                            </button>
                            <div id="test-result" class="card-panel" style="display: none; margin-top: 10px;">
                                <span id="test-message"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </li>

            <!-- SDCP Protocol Info -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">info</i>
                    <span class="translate">SDCP Protocol Info</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col s12">
                            <h6 class="translate">Supported Commands</h6>
                            <table class="striped">
                                <thead>
                                    <tr>
                                        <th class="translate">Command</th>
                                        <th class="translate">Function</th>
                                        <th class="translate">Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>0</td>
                                        <td class="translate">Request Status</td>
                                        <td class="translate">Get current printer status</td>
                                    </tr>
                                    <tr>
                                        <td>128</td>
                                        <td class="translate">Start Print</td>
                                        <td class="translate">Begin printing a file</td>
                                    </tr>
                                    <tr>
                                        <td>129</td>
                                        <td class="translate">Pause Print</td>
                                        <td class="translate">Pause current print job</td>
                                    </tr>
                                    <tr>
                                        <td>130</td>
                                        <td class="translate">Cancel Print</td>
                                        <td class="translate">Cancel current print job</td>
                                    </tr>
                                    <tr>
                                        <td>131</td>
                                        <td class="translate">Resume Print</td>
                                        <td class="translate">Resume paused print job</td>
                                    </tr>
                                    <tr>
                                        <td>386</td>
                                        <td class="translate">Camera Stream</td>
                                        <td class="translate">Enable/disable camera stream</td>
                                    </tr>
                                    <tr>
                                        <td>403</td>
                                        <td class="translate">Toggle Light</td>
                                        <td class="translate">Control printer lighting</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</div>
```

</div>

<script type="text/javascript">
    // Translation dictionary
    systemDictionary = {
        "Connection Settings": {
            "en": "Connection Settings",
            "de": "Verbindungseinstellungen"
        },
        "Printer IP Address": {
            "en": "Printer IP Address",
            "de": "Drucker IP-Adresse"
        },
        "IP address of your Elegoo Centauri Carbon printer": {
            "en": "IP address of your Elegoo Centauri Carbon printer",
            "de": "IP-Adresse Ihres Elegoo Centauri Carbon Druckers"
        },
        "WebSocket Port": {
            "en": "WebSocket Port",
            "de": "WebSocket Port"
        },
        "WebSocket port (default: 3030)": {
            "en": "WebSocket port (default: 3030)",
            "de": "WebSocket Port (Standard: 3030)"
        },
        "Poll Interval (ms)": {
            "en": "Poll Interval (ms)",
            "de": "Abfrageintervall (ms)"
        },
        "How often to request status updates": {
            "en": "How often to request status updates",
            "de": "Wie oft Statusupdates angefordert werden"
        },
        "Reconnect Interval (ms)": {
            "en": "Reconnect Interval (ms)",
            "de": "Wiederverbindungsintervall (ms)"
        },
        "Wait time before reconnection attempts": {
            "en": "Wait time before reconnection attempts",
            "de": "Wartezeit vor Wiederverbindungsversuchen"
        },
        "Camera Settings": {
            "en": "Camera Settings",
            "de": "Kamera-Einstellungen"
        },
        "Enable Camera Integration": {
            "en": "Enable Camera Integration",
            "de": "Kamera-Integration aktivieren"
        },
        "Enable camera stream monitoring and controls": {
            "en": "Enable camera stream monitoring and controls",
            "de": "Kamera-Stream-Überwachung und -Steuerung aktivieren"
        },
        "Camera Port": {
            "en": "Camera Port",
            "de": "Kamera Port"
        },
        "MJPEG camera stream port": {
            "en": "MJPEG camera stream port",
            "de": "MJPEG Kamera-Stream Port"
        },
        "Network Discovery": {
            "en": "Network Discovery",
            "de": "Netzwerk-Erkennung"
        },
        "Enable Auto-Discovery": {
            "en": "Enable Auto-Discovery",
            "de": "Auto-Erkennung aktivieren"
        },
        "Automatically discover printers on startup": {
            "en": "Automatically discover printers on startup",
            "de": "Drucker beim Start automatisch erkennen"
        },
        "Scan Network Now": {
            "en": "Scan Network Now",
            "de": "Netzwerk jetzt scannen"
        },
        "Alert Settings": {
            "en": "Alert Settings",
            "de": "Alarm-Einstellungen"
        },
        "Enable Alerts": {
            "en": "Enable Alerts",
            "de": "Alarme aktivieren"
        },
        "Enable automatic alert generation": {
            "en": "Enable automatic alert generation",
            "de": "Automatische Alarm-Generierung aktivieren"
        },
        "Alert Auto-Clear (ms)": {
            "en": "Alert Auto-Clear (ms)",
            "de": "Alarm Auto-Löschen (ms)"
        },
        "Time before alerts automatically clear": {
            "en": "Time before alerts automatically clear",
            "de": "Zeit bis Alarme automatisch gelöscht werden"
        },
        "Advanced Settings": {
            "en": "Advanced Settings",
            "de": "Erweiterte Einstellungen"
        },
        "Enable Debug Logging": {
            "en": "Enable Debug Logging",
            "de": "Debug-Protokollierung aktivieren"
        },
        "Enable detailed logging for troubleshooting": {
            "en": "Enable detailed logging for troubleshooting",
            "de": "Detaillierte Protokollierung zur Fehlerbehebung aktivieren"
        },
        "Connection Test": {
            "en": "Connection Test",
            "de": "Verbindungstest"
        },
        "Test Connection": {
            "en": "Test Connection",
            "de": "Verbindung testen"
        },
        "Test the connection to your printer to verify settings.": {
            "en": "Test the connection to your printer to verify settings.",
            "de": "Testen Sie die Verbindung zu Ihrem Drucker, um die Einstellungen zu überprüfen."
        },
        "SDCP Protocol Info": {
            "en": "SDCP Protocol Info",
            "de": "SDCP Protokoll Info"
        },
        "Supported Commands": {
            "en": "Supported Commands",
            "de": "Unterstützte Befehle"
        },
        "Command": {
            "en": "Command",
            "de": "Befehl"
        },
        "Function": {
            "en": "Function",
            "de": "Funktion"
        },
        "Description": {
            "en": "Description",
            "de": "Beschreibung"
        },
        "Request Status": {
            "en": "Request Status",
            "de": "Status anfordern"
        },
        "Get current printer status": {
            "en": "Get current printer status",
            "de": "Aktuellen Druckerstatus abrufen"
        },
        "Common MJPEG stream URLs:": {
            "en": "Common MJPEG stream URLs:",
            "de": "Häufige MJPEG-Stream-URLs:"
        },
        "Camera Stream Information": {
            "en": "Camera Stream Information",
            "de": "Kamera-Stream-Informationen"
        },
        "Discovery Results:": {
            "en": "Discovery Results:",
            "de": "Erkennungsergebnisse:"
        }
    };

    let onChange;

    // Initialize materialize components
    $(document).ready(function() {
        M.Collapsible.init($('.collapsible'));
        
        // Test connection button
        $('#test-connection').click(function() {
            testConnection();
        });

        // Manual discovery button
        $('#manual-discovery').click(function() {
            runNetworkDiscovery();
        });
    });

    // Test connection to printer
    function testConnection() {
        const host = $('#host').val();
        const port = $('#port').val();
        const $button = $('#test-connection');
        const $result = $('#test-result');
        const $message = $('#test-message');
        
        if (!host) {
            showTestResult('error', 'Please enter a printer IP address first.');
            return;
        }
        
        // Disable button and show loading
        $button.addClass('disabled');
        $button.find('span').text('Testing...');
        
        setTimeout(() => {
            try {
                const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
                if (ipRegex.test(host)) {
                    showTestResult('success', `Connection test initiated for ${host}:${port || 3030}. Check the adapter log for results.`);
                } else {
                    showTestResult('error', 'Invalid IP address format.');
                }
            } catch (error) {
                showTestResult('error', `Connection test failed: ${error.message}`);
            }
            
            // Re-enable button
            $button.removeClass('disabled');
            $button.find('span').text('Test Connection');
        }, 2000);
    }

    function showTestResult(type, message) {
        const $result = $('#test-result');
        const $message = $('#test-message');
        
        $result.removeClass('green lighten-4 red lighten-4');
        $result.css('display', 'block');
        
        if (type === 'success') {
            $result.addClass('green lighten-4');
        } else {
            $result.addClass('red lighten-4');
        }
        
        $message.text(message);
    }

    // Load settings from ioBroker
    function load(settings, onChange_) {
        if (!settings) return;
        
        onChange = onChange_;
        
        $('.value').each(function() {
            const $this = $(this);
            const id = $this.attr('id');
            let value = settings[id];
            
            // Use default value if setting is undefined
            if (value === undefined) {
                value = $this.data('default');
            }
            
            // Convert milliseconds to seconds for display
            if ($this.attr('type') === 'number' && (id === 'pollInterval' || id === 'reconnectInterval' || id === 'alertClearTimeout')) {
                if (typeof value === 'number') {
                    value = Math.floor(value / 1000);
                }
            }
            
            if ($this.attr('type') === 'checkbox') {
                $this.prop('checked', value === true || value === 'true').trigger('change');
            } else {
                $this.val(value).trigger('change');
            }
        });
        
        // Update labels for materialize
        M.updateTextFields();
        
        // Set up change listeners
        $('.value').on('input change', function() {
            if (onChange) onChange(false);
        });
        
        if (onChange) onChange(false);
    }

    // Save settings to ioBroker
    function save(callback) {
        const obj = {};
        
        $('.value').each(function() {
            const $this = $(this);
            const id = $this.attr('id');
            
            if ($this.attr('type') === 'checkbox') {
                obj[id] = $this.prop('checked');
            } else if ($this.attr('type') === 'number') {
                let value = parseInt($this.val(), 10);
                
                // Convert seconds to milliseconds for internal storage
                if (id === 'pollInterval' || id === 'reconnectInterval') {
                    value = value * 1000;
                } else if (id === 'alertClearTimeout') {
                    value = value * 1000;
                }
                
                obj[id] = isNaN(value) ? ($this.data('default') * (id.includes('Interval') || id.includes('Timeout') ? 1000 : 1)) : value;
            } else {
                obj[id] = $this.val() || $this.data('default');
            }
        });
        
        // Validate required fields
        if (!obj.host) {
            M.toast({html: 'Please enter a printer IP address', classes: 'red'});
            return;
        }
        
        // Validate IP address format
        const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipRegex.test(obj.host)) {
            M.toast({html: 'Please enter a valid IP address', classes: 'red'});
            return;
        }
        
        // Validate port ranges
        if (obj.port < 1 || obj.port > 65535) {
            M.toast({html: 'WebSocket port must be between 1 and 65535', classes: 'red'});
            return;
        }
        
        if (obj.cameraPort < 1 || obj.cameraPort > 65535) {
            M.toast({html: 'Camera port must be between 1 and 65535', classes: 'red'});
            return;
        }
        
        M.toast({html: 'Settings saved successfully', classes: 'green'});
        callback(obj);
    }
</script>

</body>
</html>
