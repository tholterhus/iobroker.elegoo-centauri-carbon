<!DOCTYPE html>

<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Elegoo Centauri Carbon Adapter Settings</title>

```
<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/materialize.css">

<script type="text/javascript" src="../../lib/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="../../lib/js/materialize.js"></script>

<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>

<style>
    body {
        background-color: #ffffff !important;
        color: #212121 !important;
    }
    
    .adapter-container {
        padding: 20px;
        max-width: 1200px;
        background-color: #ffffff !important;
    }
    
    .logo {
        width: 64px;
        height: 64px;
    }
    
    /* Fix input field visibility with high contrast */
    .input-field input[type=text], 
    .input-field input[type=number], 
    .input-field input[type=email], 
    .input-field input[type=url], 
    .input-field input[type=time], 
    .input-field input[type=date], 
    .input-field input[type=datetime], 
    .input-field input[type=datetime-local], 
    .input-field input[type=tel], 
    .input-field input[type=search], 
    .input-field textarea.materialize-textarea {
        color: #000000 !important;
        background-color: #ffffff !important;
        border-bottom: 2px solid #9e9e9e !important;
        font-size: 16px !important;
        font-weight: 500 !important;
    }
    
    .input-field input[type=text]:focus, 
    .input-field input[type=number]:focus {
        border-bottom: 2px solid #26a69a !important;
        box-shadow: 0 2px 0 0 #26a69a !important;
        color: #000000 !important;
        background-color: #ffffff !important;
    }
    
    .input-field label {
        color: #424242 !important;
        font-weight: 600 !important;
    }
    
    .input-field label.active {
        color: #26a69a !important;
        font-weight: 600 !important;
    }
    
    /* Fix helper text and description visibility with maximum contrast */
    .helper-text {
        color: #000000 !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        background-color: rgba(255,255,255,0.9) !important;
        padding: 2px 4px !important;
    }
    
    /* Fix paragraph text visibility */
    .collapsible-body p {
        color: #000000 !important;
        line-height: 1.6;
        font-weight: 500 !important;
        background-color: rgba(255,255,255,0.9) !important;
        padding: 4px !important;
    }
    
    /* Fix description text in cards */
    .card-panel p,
    .collection-item p {
        color: #000000 !important;
        font-weight: 500 !important;
    }
    
    /* Fix all text elements */
    span, div, label, p, h1, h2, h3, h4, h5, h6 {
        color: #000000 !important;
    }
    
    /* Fix checkbox visibility */
    [type="checkbox"]:checked + span:not(.lever):before {
        border-right: 2px solid #26a69a;
        border-bottom: 2px solid #26a69a;
    }
    
    /* Table styling */
    table.striped > tbody > tr:nth-child(odd) {
        background-color: rgba(242, 242, 242, 0.8);
    }
    
    table th, table td {
        color: #000000 !important;
    }
    
    .collection .collection-item {
        background-color: #fff;
        line-height: 1.5rem;
        padding: 10px 20px;
        margin: 0;
        border-bottom: 1px solid #e0e0e0;
        color: #000000 !important;
    }
    
    /* Button styling */
    .btn {
        background-color: #26a69a;
        color: #ffffff !important;
    }
    
    .btn:hover, .btn-large:hover {
        background-color: #2bbbad;
    }
    
    /* Card panel styling */
    .card-panel {
        background-color: #fff;
        padding: 24px;
        margin: 0.5rem 0 1rem 0;
        border-radius: 2px;
        box-shadow: 0 2px 2px 0 rgba(0,0,0,0.14), 0 1px 5px 0 rgba(0,0,0,0.12), 0 3px 1px -2px rgba(0,0,0,0.2);
        color: #000000 !important;
    }

    /* Collapsible headers */
    .collapsible-header {
        color: #000000 !important;
    }

    /* Footer with save/cancel buttons */
    .adapter-buttons {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #ffffff;
        border-top: 1px solid #e0e0e0;
        padding: 15px 20px;
        box-shadow: 0 -2px 4px rgba(0,0,0,0.1);
        z-index: 1000;
    }
    
    .adapter-container {
        padding-bottom: 80px; /* Make room for fixed buttons */
    }
</style>
```

</head>

<body>

<div class="m adapter-container">

```
<div class="row">
    <div class="col s12 m4 l2">
        <img src="elegoo-centauri-carbon.png" class="logo" alt="Elegoo Centauri Carbon">
    </div>
</div>

<!-- Connection Settings -->
<div class="row">
    <div class="col s12">
        <ul class="collapsible">
            <li class="active">
                <div class="collapsible-header">
                    <i class="material-icons">wifi</i>
                    <span class="translate">Connection Settings</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <input class="value" id="host" type="text"/>
                            <label for="host" class="translate">Printer IP Address</label>
                            <span class="helper-text translate">IP address of your Elegoo Centauri Carbon printer</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <input class="value" id="port" type="number" min="1" max="65535"/>
                            <label for="port" class="translate">WebSocket Port</label>
                            <span class="helper-text translate">WebSocket port (default: 3030)</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="input-field col s12 m6">
                            <input class="value" id="pollInterval" type="number" min="1" max="300"/>
                            <label for="pollInterval" class="translate">Poll Interval (seconds)</label>
                            <span class="helper-text translate">How often to request status updates (1-300 seconds)</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <input class="value" id="reconnectInterval" type="number" min="5" max="300"/>
                            <label for="reconnectInterval" class="translate">Reconnect Interval (seconds)</label>
                            <span class="helper-text translate">Wait time before reconnection attempts (5-300 seconds)</span>
                        </div>
                    </div>
                </div>
            </li>

            <!-- Camera Settings -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">videocam</i>
                    <span class="translate">Camera Settings</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col s12 m6">
                            <p>
                                <label>
                                    <input type="checkbox" class="value" id="enableCamera"/>
                                    <span class="translate">Enable Camera Integration</span>
                                </label>
                            </p>
                            <span class="helper-text translate">Enable camera stream monitoring and controls</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <input class="value" id="cameraPort" type="number" min="1" max="65535"/>
                            <label for="cameraPort" class="translate">Camera Port</label>
                            <span class="helper-text translate">MJPEG camera stream port</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            <h6 class="translate">Camera Stream Information</h6>
                            <p class="translate">Common MJPEG stream URLs:</p>
                            <div class="collection">
                                <div class="collection-item">http://192.168.178.34:8080/video_feed</div>
                                <div class="collection-item">http://192.168.178.34:8080/stream.mjpg</div>
                                <div class="collection-item">http://192.168.178.34/video_feed</div>
                            </div>
                        </div>
                    </div>
                </div>
            </li>

            <!-- Alert Settings -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">notifications</i>
                    <span class="translate">Alert Settings</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col s12 m6">
                            <p>
                                <label>
                                    <input type="checkbox" class="value" id="enableAlerts"/>
                                    <span class="translate">Enable Alerts</span>
                                </label>
                            </p>
                            <span class="helper-text translate">Enable automatic alert generation</span>
                        </div>
                        <div class="input-field col s12 m6">
                            <input class="value" id="alertClearTimeout" type="number" min="60" max="3600"/>
                            <label for="alertClearTimeout" class="translate">Alert Auto-Clear (seconds)</label>
                            <span class="helper-text translate">Time before alerts automatically clear (60-3600 seconds)</span>
                        </div>
                    </div>
                </div>
            </li>

            <!-- Advanced Settings -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">settings</i>
                    <span class="translate">Advanced Settings</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col s12 m6">
                            <p>
                                <label>
                                    <input type="checkbox" class="value" id="enableAutoDiscovery"/>
                                    <span class="translate">Enable Auto-Discovery</span>
                                </label>
                            </p>
                            <span class="helper-text translate">Test printer connection on startup</span>
                        </div>
                        <div class="col s12 m6">
                            <p>
                                <label>
                                    <input type="checkbox" class="value" id="enableDebugLogging"/>
                                    <span class="translate">Enable Debug Logging</span>
                                </label>
                            </p>
                            <span class="helper-text translate">Enable detailed logging for troubleshooting</span>
                        </div>
                    </div>
                </div>
            </li>

            <!-- Connection Test -->
            <li>
                <div class="collapsible-header">
                    <i class="material-icons">settings_ethernet</i>
                    <span class="translate">Connection Test</span>
                </div>
                <div class="collapsible-body">
                    <div class="row">
                        <div class="col s12">
                            <p class="translate">Test the connection to verify your printer settings.</p>
                            <button id="test-connection" class="btn waves-effect waves-light" type="button">
                                <i class="material-icons left">play_arrow</i>
                                <span class="translate">Test Connection</span>
                            </button>
                            <div id="test-result" class="card-panel" style="display: none; margin-top: 10px;">
                                <span id="test-message"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </li>
        </ul>
    </div>
</div>
```

</div>

<!-- Fixed Save/Cancel Buttons -->

<div class="adapter-buttons">
    <div class="row" style="margin-bottom: 0;">
        <div class="col s12">
            <button type="button" id="save" class="btn waves-effect waves-light green">
                <i class="material-icons left">save</i>
                <span class="translate">Save</span>
            </button>
            <button type="button" id="cancel" class="btn waves-effect waves-light grey" style="margin-left: 10px;">
                <i class="material-icons left">cancel</i>
                <span class="translate">Cancel</span>
            </button>
            <span id="save-status" style="margin-left: 20px; font-weight: bold;"></span>
        </div>
    </div>
</div>

<script type="text/javascript">
    // Translation dictionary
    systemDictionary = {
        "Connection Settings": {
            "en": "Connection Settings",
            "de": "Verbindungseinstellungen"
        },
        "Printer IP Address": {
            "en": "Printer IP Address", 
            "de": "Drucker IP-Adresse"
        },
        "IP address of your Elegoo Centauri Carbon printer": {
            "en": "IP address of your Elegoo Centauri Carbon printer",
            "de": "IP-Adresse Ihres Elegoo Centauri Carbon Druckers"
        },
        "WebSocket Port": {
            "en": "WebSocket Port",
            "de": "WebSocket Port"
        },
        "WebSocket port (default: 3030)": {
            "en": "WebSocket port (default: 3030)",
            "de": "WebSocket Port (Standard: 3030)"
        },
        "Poll Interval (seconds)": {
            "en": "Poll Interval (seconds)",
            "de": "Abfrageintervall (Sekunden)"
        },
        "Save": {
            "en": "Save",
            "de": "Speichern"
        },
        "Cancel": {
            "en": "Cancel", 
            "de": "Abbrechen"
        }
    };

    let onChange;
    let originalSettings = {};

    // Initialize on page load
    $(document).ready(function() {
        M.Collapsible.init($('.collapsible'));
        
        // Test connection button
        $('#test-connection').click(function() {
            testConnection();
        });

        // Save button
        $('#save').click(function() {
            save();
        });

        // Cancel button  
        $('#cancel').click(function() {
            loadSettings(originalSettings);
            showStatus('Changes cancelled', 'orange');
        });
    });

    // Test connection to printer
    function testConnection() {
        const host = $('#host').val();
        const port = $('#port').val();
        const $button = $('#test-connection');
        const $result = $('#test-result');
        const $message = $('#test-message');
        
        if (!host) {
            showTestResult('error', 'Please enter a printer IP address first.');
            return;
        }
        
        $button.addClass('disabled');
        $button.find('span').text('Testing...');
        
        setTimeout(() => {
            try {
                const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
                if (ipRegex.test(host)) {
                    showTestResult('success', `Connection test initiated for ${host}:${port || 3030}. Check the adapter log for results.`);
                } else {
                    showTestResult('error', 'Invalid IP address format.');
                }
            } catch (error) {
                showTestResult('error', `Connection test failed: ${error.message}`);
            }
            
            $button.removeClass('disabled');
            $button.find('span').text('Test Connection');
        }, 2000);
    }

    function showTestResult(type, message) {
        const $result = $('#test-result');
        const $message = $('#test-message');
        
        $result.removeClass('green lighten-4 red lighten-4');
        $result.css('display', 'block');
        
        if (type === 'success') {
            $result.addClass('green lighten-4');
        } else {
            $result.addClass('red lighten-4');
        }
        
        $message.text(message);
    }

    // Show status message
    function showStatus(message, color) {
        const $status = $('#save-status');
        $status.text(message).css('color', color || 'green');
        setTimeout(() => {
            $status.text('').css('color', '');
        }, 3000);
    }

    // Load settings from ioBroker with defaults
    function load(settings, onChange_) {
        if (!settings) settings = {};
        
        onChange = onChange_;
        originalSettings = JSON.parse(JSON.stringify(settings)); // Deep copy
        
        loadSettings(settings);
        
        // Set up change listeners
        $('.value').on('input change', function() {
            if (onChange) onChange(false);
        });
        
        if (onChange) onChange(false);
    }

    function loadSettings(settings) {
        // Define defaults
        const defaults = {
            host: '192.168.178.34',
            port: 3030,
            cameraPort: 8080,
            pollInterval: 10, // in seconds for display
            reconnectInterval: 30, // in seconds for display  
            alertClearTimeout: 300, // in seconds for display
            enableCamera: true,
            enableAlerts: true,
            enableAutoDiscovery: true,
            enableDebugLogging: false
        };

        $('.value').each(function() {
            const $this = $(this);
            const id = $this.attr('id');
            let value = settings[id];
            
            // Use default if undefined
            if (value === undefined) {
                value = defaults[id];
            }
            
            // Convert milliseconds to seconds for time intervals
            if ($this.attr('type') === 'number' && (id === 'pollInterval' || id === 'reconnectInterval' || id === 'alertClearTimeout')) {
                if (typeof value === 'number' && value >= 1000) {
                    value = Math.floor(value / 1000);
                }
            }
            
            if ($this.attr('type') === 'checkbox') {
                $this.prop('checked', value === true || value === 'true');
            } else {
                $this.val(value);
            }
        });
        
        // Update materialize labels
        M.updateTextFields();
    }

    // Save settings to ioBroker
    function save(callback) {
        const obj = {};
        
        $('.value').each(function() {
            const $this = $(this);
            const id = $this.attr('id');
            
            if ($this.attr('type') === 'checkbox') {
                obj[id] = $this.prop('checked');
            } else if ($this.attr('type') === 'number') {
                let value = parseInt($this.val(), 10);
                
                // Convert seconds to milliseconds for storage
                if (id === 'pollInterval' || id === 'reconnectInterval' || id === 'alertClearTimeout') {
                    value = value * 1000;
                }
                
                obj[id] = isNaN(value) ? (id === 'pollInterval' ? 10000 : id === 'reconnectInterval' ? 30000 : 300000) : value;
            } else {
                obj[id] = $this.val() || '192.168.178.34';
            }
        });
        
        // Validate required fields
        if (!obj.host) {
            showStatus('Please enter a printer IP address', 'red');
            return;
        }
        
        // Validate IP address format
        const ipRegex = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipRegex.test(obj.host)) {
            showStatus('Please enter a valid IP address', 'red');
            return;
        }
        
        // Validate port ranges
        if (obj.port < 1 || obj.port > 65535) {
            showStatus('WebSocket port must be between 1 and 65535', 'red');
            return;
        }
        
        if (obj.cameraPort < 1 || obj.cameraPort > 65535) {
            showStatus('Camera port must be between 1 and 65535', 'red');
            return;
        }
        
        showStatus('Settings saved successfully', 'green');
        
        // Update original settings
        originalSettings = JSON.parse(JSON.stringify(obj));
        
        if (callback) {
            callback(obj);
        } else {
            // Direct save to adapter
            if (typeof parent !== 'undefined' && parent.gMain) {
                parent.gMain.saveConfig(obj);
            }
        }
    }
</script>

</body>
</html>
